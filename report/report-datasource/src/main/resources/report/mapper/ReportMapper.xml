<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwhalecloud.retail.report.mapper.ReportMapper">

      <select id="reportDeSaleExport" parameterType="com.iwhalecloud.retail.report.dto.request.ReportDeSaleDaoReq"
            resultType="com.iwhalecloud.retail.report.dto.response.ReportDeSaleDaoResq">	
            		<include refid="reportDeSale_prefix"></include>
  </select>

  
    <select id="ListReportDeSale" parameterType="com.iwhalecloud.retail.report.dto.request.ReportDeSaleDaoReq"
            resultType="com.iwhalecloud.retail.report.dto.response.ReportDeSaleDaoResq">
				<include refid="reportDeSale_prefix"></include>
  </select>
  
    
  <sql id="reportDeSale_prefix" >
    select * from (
		select*from ( select d.*,d.sumStockDay/d.daySale sevenDayLv ,
	CASE WHEN (d.sumStockDay/d.daySale)&gt;= 10 THEN 1
	WHEN (d.sumStockDay/d.daySale) &gt;= 5 &amp;&amp; (d.sumStockDay/d.daySale)&lt;10 THEN 2
	ELSE 3 END AS redStatus
	from( select a.*,(select ROUND(sum(b.SELL_NUM)/7 ,2) from
	rpt_supplier_operating_day b
	where a.supplierName=b.supplier_name 
	and a.supplierCode=b.SUPPLIER_CODE 
	and a.PRODUCT_BASE_ID=b.PRODUCT_BASE_ID
	and a.BRAND_ID=b.BRAND_ID 
	and a.priceLevel=b.PRICE_LEVEL 
	and b.CREATE_DATE&gt;=DATE_SUB(CURDATE(), INTERVAL 7 DAY) ) daySale
	,(select sum(b.STOCK_NUM) 
	from rpt_supplier_operating_day b
	where a.supplierName=b.supplier_name 
	and a.supplierCode=b.SUPPLIER_CODE 
	and a.PRODUCT_BASE_ID=b.PRODUCT_BASE_ID
	and a.BRAND_ID=b.BRAND_ID 
	and a.priceLevel=b.PRICE_LEVEL and
	to_days(b.CREATE_DATE) = to_days(now()) ) sumStockDay,
	(select sum(b.STOCK_AMOUNT) from rpt_supplier_operating_day b
	where a.supplierName=b.supplier_name 
	and a.supplierCode=b.SUPPLIER_CODE 
	and a.PRODUCT_BASE_ID=b.PRODUCT_BASE_ID
	and a.BRAND_ID=b.BRAND_ID 
	and a.priceLevel=b.PRICE_LEVEL 
	and to_days(b.CREATE_DATE) = to_days(now()) ) sumStockAmoutDay
	from (select
	PRODUCT_BASE_ID,BRAND_ID, COUNTY_ID,city_id,
	supplier_name supplierName ,SUPPLIER_CODE supplierCode,
	PRODUCT_BASE_NAME productName,
	BRAND_NAME brandName,PRICE_LEVEL priceLevel,
	(sum(TRANS_IN_NUM)+sum(MANUAL_NUM)+sum(PURCHASE_NUM)) totalInnum ,
	(sum(TRANS_OUT_NUM)+sum(RETURN_NUM)+sum(SELL_NUM)) totalOutNum,
	sum(PURCHASE_NUM) sumPurchase,
	sum(PURCHASE_AMOUNT) amoutPurcchase,sum(MANUAL_NUM) sumMANUAL,
	sum(TRANS_IN_NUM) sumTransIn,sum(SELL_NUM) sumSellNum,
	sum(SELL_AMOUNT) sumSellAmout,sum(TRANS_OUT_NUM)
	sumTransOut,sum(RETURN_NUM) sumReturn,type_id typeId
	from rpt_supplier_operating_day
	where 1=1
	<if test="req.createTimeStart!=null and req.createTimeStart!=''">
		and item_date &gt;= str_to_date(#{req.createTimeStart}, '%Y-%m-%d')
	</if>
	<if test="req.createTimeEnd!=null and req.createTimeEnd!=''">
			and item_date &lt;= str_to_date(#{req.createTimeEnd}, '%Y-%m-%d')
	</if>
	<if test="req.outTimeStart!=null and req.outTimeStart!=''">
		and item_date &gt;= str_to_date(#{req.outTimeStart}, '%Y-%m-%d')
	</if>
	<if test="req.outTimeEnd!=null and req.outTimeEnd!=''">
			and item_date &lt;= str_to_date(#{req.outTimeEnd}, '%Y-%m-%d')
	</if>
	<if test="req.typeId!=null and req.typeId!=''">
			and type_id = #{req.typeId}
	</if>
	group by supplier_name,
	SUPPLIER_CODE,PRODUCT_BASE_ID ,BRAND_ID,PRICE_LEVEL)
	a) d where 1=1 
	<if test="req.brand!=null and req.brand!=''">
		and d.brand_id = #{req.brand}
	</if>
	<if test="req.productType!=null and req.productType!=''">
		and d.product_base_id = #{req.productType}
	</if>
		<if test="req.merchantName!=null and req.merchantName!=''">
		and d.suppliername like CONCAT(CONCAT('%',#{req.merchantName}),'%')
	</if>
	<if test="req.merchantCode!=null and req.merchantCode!=''">
		and d.suppliercode  like CONCAT(CONCAT('%',#{req.merchantCode}),'%')
	</if>
	
	<if test="req.gear!=null and req.gear!=''">
		and d.pricelevel=#{req.gear}
	</if>
		<if test="req.lanId!=null and req.lanId!=''">
		and d.city_id  =#{req.lanId}
	</if>
	<if test="req.city!=null and req.city!=''">
		and d.COUNTY_ID=#{req.city}
	</if>
	) x where 1=1
	<if test="req.warningStatus!=null and req.warningStatus!=''">
 	and	redStatus=#{req.warningStatus}
	</if>
	limit 60000) z
	</sql>
  
     <select id="listProductAll" parameterType="String"
            resultType="com.iwhalecloud.retail.report.dto.response.ProductListAllResp">
	select product_base_id productId,product_name productName from prod_product_base   
	where 1=1
		<if test="brandId!=null and brandId!=''">
		and brand_id = #{brandId}
	</if>
  </select>
  
  
</mapper>
