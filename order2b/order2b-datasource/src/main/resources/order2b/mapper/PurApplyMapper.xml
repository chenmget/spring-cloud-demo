<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwhalecloud.retail.order2b.mapper.PurApplyMapper">
  
    <select id="cgSearchApply" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.PurApplyReq"
            resultType="com.iwhalecloud.retail.order2b.dto.response.purapply.PurApplyResp">
		SELECT 
			a.APPLY_ID AS applyId,
			a.APPLY_CODE AS applyCode,
			a.APPLY_NAME AS projectName,
			a.CREATE_DATE AS applyTime,
			(SELECT b.REGION_NAME FROM SYS_COMMON_REGION b WHERE b.REGION_ID=a.LAN_ID) AS applyAddress,
			(SELECT b.MERCHANT_NAME FROM PAR_MERCHANT b WHERE b.MERCHANT_ID=a.MERCHANT_ID) AS supplierName,
			a.STATUS_CD AS STATUS,
			'' AS `option`
			 FROM PUR_APPLY a
			 WHERE 1=1
			 and a.STATUS_CD != '1100'
		 <if test='req.applyCode!=null and req.applyCode!=""'>  
			and a.APPLY_CODE = #{req.applyCode}
		</if>
		<if test='req.applyType!=null and req.applyType!=""'>  
			and a.APPLY_TYPE = #{req.applyType}
		</if>
		<if test='req.projectName!=null and req.projectName!=""'>  
			and a.APPLY_NAME like CONCAT(CONCAT('%',#{req.projectName}),'%')	
		</if>
		<if test='req.startDate!=null and req.startDate!=""'>
			and a.CREATE_DATE &gt;= str_to_date(#{req.startDate}, '%Y-%m-%d')
		</if>
		<if test='req.endDate!=null and req.endDate!=""'>
			and a.CREATE_DATE &lt;= str_to_date(#{req.endDate}, '%Y-%m-%d')
		</if>
		<if test='req.lanId!=null and req.lanId!=""'>  
			and a.LAN_ID = #{req.lanId}
		</if>
  </select>
  
  <select id="crPurApplyFile" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.AddFileReq">
	insert into PUR_APPLY_FILE(
		FILE_ID,
		APPLY_ID,
		FILE_TYPE,
		FILE_URL,
		CREATE_STAFF,
		CREATE_DATE,
		UPDATE_STAFF,
		UPDATE_DATE,
		FILE_NAME,
		UID
	) values (
		#{req.fileId},
		#{req.applyId},
		#{req.fileType},
		#{req.url},
		#{req.createStaff},
		#{req.createDate},
		#{req.updateStaff},
		#{req.updateDate},
		#{req.name},
		#{req.uid}
	)
  </select>
  
  <select id="crPurApplyItem" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.AddProductReq">
	insert into PUR_APPLY_ITEM(
		APPLY_ITEM_ID,
		APPLY_ID,
		PRODUCT_ID,
		PUR_NUM,
		PUR_PRICE,
		PUR_TYPE,
		STATUS_CD,
		CREATE_STAFF,
		CREATE_DATE,
		UPDATE_STAFF,
		UPDATE_DATE,
		STATUS_DATE
	) values (
		#{req.applyItemId},
		#{req.applyId},
		#{req.productName},
		#{req.snCount},
		#{req.priceInStore},
		#{req.purchaseType},
		#{req.statusCd},
		#{req.createStaff},
		#{req.createDate},
		#{req.updateStaff},
		#{req.updateDate},
		#{req.statusDate}
	)
  </select>
  
  <select id="tcProcureApply" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.ProcureApplyReq">
	insert into PUR_APPLY(
		APPLY_ID,
		APPLY_CODE,
		APPLY_NAME,
		APPLY_TYPE,
		CONTENT,
		MERCHANT_ID,
		MERCHANT_CODE,
		APPLY_MERCHANT_ID,
		APPLY_MERCHANT_CODE,
		PHONE,
		LAN_ID,
		REGION_ID,
		REL_APPLY_ID,
		STATUS_CD,
		CREATE_STAFF,
		CREATE_DATE,
		UPDATE_STAFF,
		UPDATE_DATE,
		STATUS_DATE
	) values (
		#{req.applyId},
		#{req.applyCode},
		#{req.applyName},
		#{req.applyType},
		#{req.content},
		#{req.supplier},
		#{req.merchantCode},
		#{req.applyMerchantId},
		#{req.applyMerchantCode},
		#{req.applyContact},
		#{req.applyAdress},
		#{req.regionId},
		#{req.relApplyId},
		#{req.statusCd},
		#{req.createStaff},
		#{req.createDate},
		#{req.updateStaff},
		#{req.updateDate},
		#{req.statusDate}
	)
  </select>
  
  <select id="delSearchApply" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.PurApplyReq">
  	update pur_apply set status_cd='1100' where 1=1 and apply_id = #{req.applyId}
  </select>
  
  <select id="hqShenQingDaoHao"  resultType="com.iwhalecloud.retail.order2b.dto.response.purapply.ApplyHeadResp">
  	select seq_pur_apply_id.nextval as applyId
  </select>
  
  <select id="hqDiShiBuMen" parameterType="String" resultType="String">
  	SELECT region_name FROM sys_common_region WHERE region_id = #{dsbm}
  </select>
  
  <select id="ckApplyData1" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.PurApplyReq" 
  		resultType="com.iwhalecloud.retail.order2b.dto.response.purapply.CkProcureApplyResp">
  	SELECT 
  		a.apply_id as applyId,
		a.apply_code as applyCode,
		a.apply_merchant_code  AS applyMerchantCode,
		(SELECT b.MERCHANT_NAME FROM PAR_MERCHANT b WHERE b.MERCHANT_CODE=a.apply_merchant_code) AS applyMerchantName,
		a.LAN_ID as lanId,
		(SELECT b.REGION_NAME FROM SYS_COMMON_REGION b WHERE b.REGION_ID=a.LAN_ID) AS applyAddress,
		a.region_id as regionId,
		(SELECT b.REGION_NAME FROM SYS_COMMON_REGION b WHERE b.REGION_ID=a.region_id) AS applyDepartment,
		a.phone as applyContact,
		a.apply_name as applyName,
		a.merchant_code as supplierCode,
		(SELECT b.MERCHANT_NAME FROM PAR_MERCHANT b WHERE b.MERCHANT_CODE=a.merchant_code) AS supplierName,
		a.status_cd as statusCd,
		a.create_date as createDate
	FROM 
		pur_apply a
		where 1=1 and a.apply_id = #{req.applyId}
 
  </select>
  
  <select id="ckApplyData2" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.PurApplyReq" 
  		resultType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.AddProductReq">
  	SELECT e.*,
  		f.name AS brandName ,
  		h.type_name AS typeName
  	FROM (
		SELECT c.*,
			d.PRODUCT_NAME AS productName,
			d.BRAND_ID,
			d.UNIT_TYPE AS unitType,
			d.IS_FIXED_LINE AS isFixedLine,
			d.TYPE_ID
			FROM	
				(SELECT 
				a.PRODUCT_ID,
				a.APPLY_ID AS applyId,
				a.APPLY_ITEM_ID AS applyItemId,
				a.STATUS_CD AS statusCd,
				b.product_base_id,
				b.MEMORY AS specName,	
				b.COLOR AS color,	
				b.COST AS cost,
				b.SN AS sn,		
				a.PUR_NUM AS snCount,	
				a.PUR_PRICE AS priceInStore,	
				a.PUR_TYPE AS purchaseType
				FROM 
				pur_apply_item a
				LEFT JOIN prod_product b ON a.product_id=b.product_id
				WHERE 1=1 AND a.apply_id = #{req.applyId}
				) c
			LEFT JOIN prod_product_base d ON c.product_base_id=d.product_base_id
			) e 
	LEFT JOIN prod_brand f ON e.brand_id=f.brand_id
	LEFT JOIN prod_type h ON e.type_id = h.type_id
 
 
  </select>
  
  <select id="ckApplyData3" parameterType="com.iwhalecloud.retail.order2b.dto.resquest.purapply.PurApplyReq" 
  		resultType="com.iwhalecloud.retail.order2b.dto.response.purapply.PurApplyFileResp">
  	select 
  		a.file_url as url ,
  		a.uid as uid,
  		a.file_name as name
  		from pur_apply_file a 
  		where 1=1 and a.apply_id =#{req.applyId}
  </select>
  
  <select id="isHaveSave" parameterType="String" resultType="Integer">
	SELECT COUNT(*) AS isHaveSave FROM PUR_APPLY WHERE 1=1 and apply_id =#{applyId}
  </select>
  
  <select id="updatePurApply"  parameterType="String">
	UPDATE PUR_APPLY SET status_cd= '20' WHERE apply_id=#{applyId}
  </select>
  
  <select id="getMerchantId"  parameterType="String"  resultType="String">
	SELECT merchant_id FROM par_merchant WHERE 1=1 AND merchant_code=#{merchantCode}
  </select>
  
  <select id="hqSeqFileId"  resultType="String">
  	select seq_pur_apply_file_id.nextval as fileId
  </select>
  
  <select id="hqSeqItemId"  resultType="String">
  	select seq_pur_apply_item_id.nextval as itemId
  </select>
</mapper>

